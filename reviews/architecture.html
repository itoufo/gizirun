<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>アーキテクチャレビュー - Notta レビュー</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.7; }
    .header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #fff; padding: 2.5rem 2rem; }
    .header h1 { font-size: 1.75rem; font-weight: 700; letter-spacing: 0.02em; }
    .header .meta { font-size: 0.875rem; color: #94a3b8; margin-top: 0.5rem; }
    .container { max-width: 960px; margin: 0 auto; padding: 2rem 1.5rem; }
    .grade-section { display: flex; align-items: center; gap: 2rem; margin-bottom: 2.5rem; padding: 1.5rem; background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .grade-badge { width: 88px; height: 88px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.25rem; font-weight: 800; color: #fff; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .grade-A { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .grade-B { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .grade-C { background: linear-gradient(135deg, #eab308, #ca8a04); }
    .grade-D { background: linear-gradient(135deg, #f97316, #ea580c); }
    .grade-F { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .grade-text h2 { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; }
    .grade-text p { color: #475569; font-size: 0.9375rem; }
    .section-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e2e8f0; }
    .findings-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 2.5rem; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .findings-table th { background: #1e293b; color: #fff; padding: 0.875rem 1rem; text-align: left; font-size: 0.8125rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .findings-table td { padding: 0.875rem 1rem; border-bottom: 1px solid #e2e8f0; font-size: 0.875rem; vertical-align: top; background: #fff; }
    .findings-table tr:last-child td { border-bottom: none; }
    .findings-table tr:hover td { background: #f8fafc; }
    .severity { display: inline-block; padding: 0.1875rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; color: #fff; letter-spacing: 0.025em; }
    .severity-critical { background: #dc2626; }
    .severity-high { background: #ea580c; }
    .severity-medium { background: #ca8a04; }
    .severity-low { background: #65a30d; }
    .file-path { font-family: 'SF Mono', 'Fira Code', Consolas, monospace; font-size: 0.8rem; color: #6366f1; word-break: break-all; }
    .roadmap { margin-bottom: 2rem; }
    .roadmap-item { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 1.25rem 1.5rem; margin-bottom: 0.75rem; display: flex; gap: 1rem; align-items: flex-start; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .roadmap-number { width: 32px; height: 32px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; flex-shrink: 0; }
    .roadmap-content strong { display: block; margin-bottom: 0.25rem; }
    .roadmap-content p { color: #64748b; font-size: 0.875rem; margin: 0; }
    .stats-bar { display: flex; gap: 1rem; margin-bottom: 2.5rem; flex-wrap: wrap; }
    .stat-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem 1.25rem; flex: 1; min-width: 120px; text-align: center; }
    .stat-card .stat-value { font-size: 1.5rem; font-weight: 800; }
    .stat-card .stat-label { font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; }
    .stat-critical { color: #dc2626; }
    .stat-high { color: #ea580c; }
    .stat-medium { color: #ca8a04; }
    .stat-low { color: #65a30d; }
    .footer { text-align: center; color: #94a3b8; font-size: 0.75rem; padding: 2rem 0; border-top: 1px solid #e2e8f0; margin-top: 2rem; }
    .back-link { display: inline-block; margin-bottom: 1.5rem; color: #3b82f6; text-decoration: none; font-size: 0.875rem; font-weight: 500; }
    .back-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="header">
    <h1>アーキテクチャレビュー</h1>
    <div class="meta">Notta | 2026-01-29</div>
  </div>
  <div class="container">
    <a href="index.html" class="back-link">&larr; ダッシュボードに戻る</a>

    <div class="grade-section">
      <div class="grade-badge grade-B">B</div>
      <div class="grade-text">
        <h2>総合評価</h2>
        <p>Next.js App Routerの規約に沿ったディレクトリ構成で、関心の分離も概ね適切。API routeは薄いコントローラとして機能し、ビジネスロジックはlib/に集約されている。ただし、インメモリ状態管理（TopicOrchestrator, SessionManager）がサーバーレス環境と不整合であり、一部のAPIルートが肥大化（topic-analysis/segment: 320行）している点が改善対象。データベース設計は正規化されており、リレーションも適切に定義されている。</p>
      </div>
    </div>

    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-value stat-critical">0</div>
        <div class="stat-label">Critical</div>
      </div>
      <div class="stat-card">
        <div class="stat-value stat-high">4</div>
        <div class="stat-label">High</div>
      </div>
      <div class="stat-card">
        <div class="stat-value stat-medium">5</div>
        <div class="stat-label">Medium</div>
      </div>
      <div class="stat-card">
        <div class="stat-value stat-low">3</div>
        <div class="stat-label">Low</div>
      </div>
    </div>

    <h2 class="section-title">検出事項</h2>
    <table class="findings-table">
      <thead>
        <tr>
          <th>カテゴリ</th>
          <th>ファイル</th>
          <th>重要度</th>
          <th>説明</th>
          <th>推奨対応</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>関心の分離</td>
          <td class="file-path">src/app/api/topic-analysis/segment/route.ts:1-320</td>
          <td><span class="severity severity-high">HIGH</span></td>
          <td>320行の巨大APIルート。コスト計算、圧縮設定、DB状態管理、分析トリガー判定、アラート生成など多数の責務が混在している。</td>
          <td>コスト計算・圧縮ロジック・アラート生成をそれぞれlib/配下のモジュールに切り出し、route.tsはコントローラとしてオーケストレーションに専念させる。</td>
        </tr>
        <tr>
          <td>状態管理</td>
          <td class="file-path">src/lib/meeting/topic-orchestrator.ts:1-130</td>
          <td><span class="severity severity-high">HIGH</span></td>
          <td>シングルトンパターンでインメモリ状態（meetingStates Map）を保持。Vercelサーバーレス環境ではリクエストごとにプロセスが異なる可能性があり、状態が失われる。</td>
          <td>topic-analysis/segment/route.tsのようにDB永続化パターンに統一する。既にTopicAnalysisStateモデルが存在するため移行は容易。</td>
        </tr>
        <tr>
          <td>状態管理</td>
          <td class="file-path">src/lib/recording/session-manager.ts:1-80</td>
          <td><span class="severity severity-high">HIGH</span></td>
          <td>インメモリのセッション管理（Map + setInterval）。サーバーレスでは動作しない。1時間のauto-cleanupタイマーも機能しない。</td>
          <td>DB永続化（TopicAnalysisStateと同様のパターン）に移行する。セッション状態をPrismaモデルとして追加。</td>
        </tr>
        <tr>
          <td>サーバー分離</td>
          <td class="file-path">server/websocket.ts:1-250</td>
          <td><span class="severity severity-high">HIGH</span></td>
          <td>WebSocketサーバーがNext.jsとは別プロセス（port 3001）として動作。Vercel等のサーバーレスプラットフォームではデプロイ・運用が複雑。Deepgramとの接続管理もこのサーバーに依存。</td>
          <td>長期的にはSupabase Realtimeへの移行を検討。短期的にはRailway/Fly.io等で別サービスとしてデプロイし、環境変数でURLを管理する。</td>
        </tr>
        <tr>
          <td>API設計</td>
          <td class="file-path">src/app/api/transcripts/route.ts:28-30</td>
          <td><span class="severity severity-medium">MEDIUM</span></td>
          <td>トランスクリプト一覧取得にページネーションが未実装。データ量が増えるとレスポンスが肥大化する。</td>
          <td>cursor-basedまたはoffset-basedページネーションを導入し、デフォルトの取得件数を制限する。</td>
        </tr>
        <tr>
          <td>API設計</td>
          <td class="file-path">src/app/api/meetings/route.ts:28-35</td>
          <td><span class="severity severity-medium">MEDIUM</span></td>
          <td>ミーティング一覧も同様にページネーション未実装。</td>
          <td>トランスクリプトと同じページネーションパターンを適用する。</td>
        </tr>
        <tr>
          <td>依存管理</td>
          <td class="file-path">src/lib/meeting-bot/client.ts:47</td>
          <td><span class="severity severity-medium">MEDIUM</span></td>
          <td>ESMプロジェクトで<code>require('crypto')</code>を使用。他のファイルは全てESMインポートを使用しており、一貫性がない。</td>
          <td><code>import crypto from 'crypto'</code>に変更する。</td>
        </tr>
        <tr>
          <td>データフロー</td>
          <td class="file-path">src/app/api/webhooks/meeting-bot/route.ts:1-200</td>
          <td><span class="severity severity-medium">MEDIUM</span></td>
          <td>Webhookハンドラが200行超で、ボットライフサイクル管理・トランスクリプト処理・WebSocket配信・トピック分析連携を担当。責務が多い。</td>
          <td>イベント種別ごとのハンドラ関数に分割し、route.tsはディスパッチャーとして機能させる。</td>
        </tr>
        <tr>
          <td>コンポーネント構造</td>
          <td class="file-path">src/app/(dashboard)/record/page.tsx:1-500</td>
          <td><span class="severity severity-medium">MEDIUM</span></td>
          <td>録音ページが大型コンポーネント（約500行）。録音制御、WebSocket接続、セグメント表示、トピック分析表示など複数の機能を1ファイルで管理。</td>
          <td>録音制御・セグメント表示・トピックパネルをそれぞれサブコンポーネントに分割する。</td>
        </tr>
        <tr>
          <td>DB設計</td>
          <td class="file-path">prisma/schema.prisma:1-120</td>
          <td><span class="severity severity-low">LOW</span></td>
          <td>TranscriptSegmentのstartTime/endTimeがFloat型。精度が必要な場合はDecimalの方が適切。</td>
          <td>現行の用途では問題ないが、将来的にミリ秒精度が必要な場合はDecimal型への変更を検討。</td>
        </tr>
        <tr>
          <td>ディレクトリ構成</td>
          <td class="file-path">src/types/transcript.ts:1-60</td>
          <td><span class="severity severity-low">LOW</span></td>
          <td>型定義ファイルが1つのみ。Prismaの生成型と独自定義型が混在する可能性がある。</td>
          <td>Prismaの生成型をベースに、フロントエンド用の型変換レイヤーを整理する。</td>
        </tr>
        <tr>
          <td>設定管理</td>
          <td class="file-path">src/app/api/topic-analysis/segment/route.ts:7-11</td>
          <td><span class="severity severity-low">LOW</span></td>
          <td>モデル料金やUSD/JPYレートがハードコードされている。料金変更時にコード変更が必要。</td>
          <td>環境変数または設定ファイルに外出しする。</td>
        </tr>
      </tbody>
    </table>

    <h2 class="section-title">改善ロードマップ</h2>
    <div class="roadmap">
      <div class="roadmap-item">
        <div class="roadmap-number">1</div>
        <div class="roadmap-content">
          <strong>インメモリ状態管理のDB永続化統一</strong>
          <p>TopicOrchestrator と SessionManager をDB永続化パターンに移行する。TopicAnalysisStateの既存パターンを参考に、サーバーレス環境で安全に動作するようにする。</p>
        </div>
      </div>
      <div class="roadmap-item">
        <div class="roadmap-number">2</div>
        <div class="roadmap-content">
          <strong>巨大APIルートのリファクタリング</strong>
          <p>topic-analysis/segment/route.ts（320行）とwebhooks/meeting-bot/route.ts（200行超）を分割。コスト計算・圧縮・アラート生成・イベントハンドリングをlib/配下のモジュールに切り出す。</p>
        </div>
      </div>
      <div class="roadmap-item">
        <div class="roadmap-number">3</div>
        <div class="roadmap-content">
          <strong>ページネーション導入</strong>
          <p>トランスクリプト一覧・ミーティング一覧APIにcursor-basedページネーションを追加し、大量データでのパフォーマンス劣化を防止する。</p>
        </div>
      </div>
      <div class="roadmap-item">
        <div class="roadmap-number">4</div>
        <div class="roadmap-content">
          <strong>WebSocketサーバーのデプロイ戦略策定</strong>
          <p>server/websocket.tsのデプロイ先を明確にする。Supabase RealtimeやSocketIO等の代替も含めて、プロダクション運用に適したリアルタイム通信アーキテクチャを決定する。</p>
        </div>
      </div>
      <div class="roadmap-item">
        <div class="roadmap-number">5</div>
        <div class="roadmap-content">
          <strong>大型ページコンポーネントの分割</strong>
          <p>record/page.tsx等の大型コンポーネントをサブコンポーネントに分割し、テスト容易性と再利用性を向上させる。</p>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
    Generated by Claude Code Project Review | 2026-01-29T00:00:00Z
  </div>
</body>
</html>