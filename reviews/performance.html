<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>パフォーマンスレビュー - Notta レビュー</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.7; }
    .header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #fff; padding: 2.5rem 2rem; }
    .header h1 { font-size: 1.75rem; font-weight: 700; letter-spacing: 0.02em; }
    .header .meta { font-size: 0.875rem; color: #94a3b8; margin-top: 0.5rem; }
    .container { max-width: 960px; margin: 0 auto; padding: 2rem 1.5rem; }
    .grade-section { display: flex; align-items: center; gap: 2rem; margin-bottom: 2.5rem; padding: 1.5rem; background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .grade-badge { width: 88px; height: 88px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.25rem; font-weight: 800; color: #fff; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .grade-A { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .grade-B { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .grade-C { background: linear-gradient(135deg, #eab308, #ca8a04); }
    .grade-D { background: linear-gradient(135deg, #f97316, #ea580c); }
    .grade-F { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .grade-text h2 { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; }
    .grade-text p { color: #475569; font-size: 0.9375rem; }
    .section-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e2e8f0; }
    .findings-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 2.5rem; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .findings-table th { background: #1e293b; color: #fff; padding: 0.875rem 1rem; text-align: left; font-size: 0.8125rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .findings-table td { padding: 0.875rem 1rem; border-bottom: 1px solid #e2e8f0; font-size: 0.875rem; vertical-align: top; background: #fff; }
    .findings-table tr:last-child td { border-bottom: none; }
    .findings-table tr:hover td { background: #f8fafc; }
    .severity { display: inline-block; padding: 0.1875rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; color: #fff; letter-spacing: 0.025em; }
    .severity-critical { background: #dc2626; }
    .severity-high { background: #ea580c; }
    .severity-medium { background: #ca8a04; }
    .severity-low { background: #65a30d; }
    .file-path { font-family: 'SF Mono', 'Fira Code', Consolas, monospace; font-size: 0.8rem; color: #6366f1; word-break: break-all; }
    .roadmap { margin-bottom: 2rem; }
    .roadmap-item { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 1.25rem 1.5rem; margin-bottom: 0.75rem; display: flex; gap: 1rem; align-items: flex-start; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .roadmap-number { width: 32px; height: 32px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; flex-shrink: 0; }
    .roadmap-content strong { display: block; margin-bottom: 0.25rem; }
    .roadmap-content p { color: #64748b; font-size: 0.875rem; margin: 0; }
    .stats-bar { display: flex; gap: 1rem; margin-bottom: 2.5rem; flex-wrap: wrap; }
    .stat-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem 1.25rem; flex: 1; min-width: 120px; text-align: center; }
    .stat-card .stat-value { font-size: 1.5rem; font-weight: 800; }
    .stat-card .stat-label { font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; }
    .stat-critical { color: #dc2626; }
    .stat-high { color: #ea580c; }
    .stat-medium { color: #ca8a04; }
    .stat-low { color: #65a30d; }
    .footer { text-align: center; color: #94a3b8; font-size: 0.75rem; padding: 2rem 0; border-top: 1px solid #e2e8f0; margin-top: 2rem; }
    .back-link { display: inline-block; margin-bottom: 1.5rem; color: #3b82f6; text-decoration: none; font-size: 0.875rem; font-weight: 500; }
    .back-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="header">
    <h1>パフォーマンスレビュー</h1>
    <div class="meta">Notta | 2026-01-29</div>
  </div>
  <div class="container">
    <a href="index.html" class="back-link">&larr; ダッシュボードに戻る</a>

    <div class="grade-section">
      <div class="grade-badge grade-C">C</div>
      <div class="grade-text">
        <h2>総合評価</h2>
        <p>React Queryのキャッシュ（staleTime: 60s）やServer Componentsの活用は適切だが、複数のAPIルートでページネーション未実装、N+1クエリのリスク、過剰なデータ取得（include全フィールド）が見られる。会話圧縮機能の導入はパフォーマンス面で好ましいが、AI APIコール自体のコスト最適化にはまだ改善余地がある。WebSocket接続のクリーンアップは適切に実装されている。</p>
      </div>
    </div>

    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-value stat-critical">0</div>
        <div class="stat-label">Critical</div>
      </div>
      <div class="stat-card">
        <div class="stat-value stat-high">3</div>
        <div class="stat-label">High</div>
      </div>
      <div class="stat-card">
        <div class="stat-value stat-medium">5</div>
        <div class="stat-label">Medium</div>
      </div>
      <div class="stat-card">
        <div class="stat-value stat-low">3</div>
        <div class="stat-label">Low</div>
      </div>
    </div>

    <h2 class="section-title">検出事項</h2>
    <table class="findings-table">
      <thead>
        <tr>
          <th>カテゴリ</th>
          <th>ファイル</th>
          <th>重要度</th>
          <th>説明</th>
          <th>推奨対応</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>クエリ最適化</td>
          <td class="file-path">src/app/api/transcripts/route.ts:28-40</td>
          <td><span class="severity severity-high">HIGH</span></td>
          <td>トランスクリプト一覧でinclude: { segments: true, speakers: true, summary: true }を常に取得。一覧表示にセグメント全件は不要。データ量が増えるとレスポンスが肥大化。</td>
          <td>一覧用にはselectで必要なフィールドのみ取得し、_countでセグメント数だけ返す。詳細取得は個別エンドポイントに委譲。</td>
        </tr>
        <tr>
          <td>ページネーション</td>
          <td class="file-path">src/app/api/transcripts/route.ts:25-45</td>
          <td><span class="severity severity-high">HIGH</span></td>
          <td>ページネーション未実装。全トランスクリプトを一括取得。ユーザーのデータ量増加に伴いレスポンス時間とメモリ使用量が線形増加。</td>
          <td>cursor-basedページネーション（Prismaのcursor + take）を導入。デフォルト20件、最大100件。</td>
        </tr>
        <tr>
          <td>ページネーション</td>
          <td class="file-path">src/app/api/meetings/route.ts:25-40</td>
          <td><span class="severity severity-high">HIGH</span></td>
          <td>ミーティング一覧も同様にページネーション未実装。deep includeで関連データ全取得。</td>
          <td>トランスクリプトと同パターンでページネーションを導入。</td>
        </tr>
        <tr>
          <td>データベース</td>
          <td class="file-path">prisma/schema.prisma:40-50</td>
          <td><span class="severity severity-medium">MEDIUM</span></td>
          <td>TranscriptSegmentにstartTimeのインデックスがない。セグメントの時間順ソートが頻繁に発生するが、インデックスなしだと全件スキャンになる。</td>
          <td>TranscriptSegmentの(transcriptId, startTime)に複合インデックスを追加。</td>
        </tr>
        <tr>
          <td>キャッシュ</td>
          <td class="file-path">src/app/(dashboard)/transcripts/page.tsx:20-30</td>
          <td><span class="severity severity-medium">MEDIUM</span></td>
          <td>トランスクリプト一覧をuseQuery（staleTime: 60s）でフェッチ。サーバーコンポーネントとして初期データをSSRで取得し、hydrationする方がFCPが改善する。</td>
          <td>Server Componentで初期データを取得し、initialDataとしてReact Queryに渡すパターンを検討。</td>
        </tr>
        <tr>
          <td>クエリ最適化</td>
          <td class="file-path">src/app/api/meetings/[id]/route.ts:15-30</td>
          <td><span class="severity severity-medium">MEDIUM</span></td>
          <td>ミーティング詳細取得で深いネスト（topics, facilitatorAlerts, transcript.segments等）を全て一括取得。初期表示に不要なデータも含まれる。</td>
          <td>必要なリレーションのみselectし、セグメントは別途ページネーション付きで取得。</td>
        </tr>
        <tr>
          <td>バンドルサイズ</td>
          <td class="file-path">src/app/(dashboard)/record/page.tsx:1-10</td>
          <td><span class="severity severity-medium">MEDIUM</span></td>
          <td>録音ページに'use client'が必要だが、コンポーネントが大型（500行）のためクライアントバンドルに大きく寄与。</td>
          <td>Server Componentでページシェルを描画し、クライアント部分のみdynamic importで遅延ロード。</td>
        </tr>
        <tr>
          <td>メモリリーク</td>
          <td class="file-path">src/app/api/topic-analysis/segment/route.ts:55-110</td>
          <td><span class="severity severity-medium">MEDIUM</span></td>
          <td>allProcessedSegmentsがDB上のJSONカラムに蓄積され続ける。圧縮機構はあるが、長時間の会議ではDBレコードのサイズが大きくなる。</td>
          <td>SEGMENTS_TO_KEEP_RAWの値を適切に調整し、圧縮後のセグメントは確実に切り捨てる。最大値のハードリミットも設定。</td>
        </tr>
        <tr>
          <td>レンダリング</td>
          <td class="file-path">src/hooks/useWebSocket.ts:25-40</td>
          <td><span class="severity severity-low">LOW</span></td>
          <td>WebSocketメッセージ受信ごとにonMessageコールバックが発火。高頻度メッセージ（リアルタイム文字起こし）で不要な再レンダリングが発生する可能性。</td>
          <td>メッセージをバッファリングし、requestAnimationFrameまたは一定間隔でバッチ更新する。</td>
        </tr>
        <tr>
          <td>AI APIコスト</td>
          <td class="file-path">src/app/api/topic-analysis/segment/route.ts:226-233</td>
          <td><span class="severity severity-low">LOW</span></td>
          <td>トピック分析にgpt-5.2（高コスト）を使用。多くの分析はgpt-5-miniで十分な精度が得られる可能性。</td>
          <td>初回分析のみgpt-5.2、以降のインクリメンタル分析はgpt-5-miniにダウングレードする等の段階的戦略を検討。</td>
        </tr>
        <tr>
          <td>アセット最適化</td>
          <td class="file-path">next.config.js</td>
          <td><span class="severity severity-low">LOW</span></td>
          <td>Next.js Image最適化の活用度が低い。画像アセットが少ないプロジェクトのため影響は限定的。</td>
          <td>今後画像を追加する場合はnext/imageコンポーネントを使用する。</td>
        </tr>
      </tbody>
    </table>

    <h2 class="section-title">改善ロードマップ</h2>
    <div class="roadmap">
      <div class="roadmap-item">
        <div class="roadmap-number">1</div>
        <div class="roadmap-content">
          <strong>全一覧APIにページネーション導入</strong>
          <p>transcripts、meetings一覧にcursor-basedページネーションを追加。デフォルト20件取得、フロントエンドにinfinite scrollまたはページネーションUIを実装。</p>
        </div>
      </div>
      <div class="roadmap-item">
        <div class="roadmap-number">2</div>
        <div class="roadmap-content">
          <strong>クエリ最適化（select/include精査）</strong>
          <p>一覧取得時はselectで必要フィールドのみ取得。segments全件取得を廃止し、_countのみ返す。詳細取得も必要なリレーションのみinclude。</p>
        </div>
      </div>
      <div class="roadmap-item">
        <div class="roadmap-number">3</div>
        <div class="roadmap-content">
          <strong>DBインデックス追加</strong>
          <p>TranscriptSegmentの(transcriptId, startTime)複合インデックスを追加。頻繁にクエリされるフィールドのインデックスカバレッジを確認。</p>
        </div>
      </div>
      <div class="roadmap-item">
        <div class="roadmap-number">4</div>
        <div class="roadmap-content">
          <strong>SSR初期データ戦略</strong>
          <p>主要一覧ページ（transcripts, meetings）でServer Componentから初期データを取得し、React Queryにhydrationする。FCPとTTIの改善。</p>
        </div>
      </div>
      <div class="roadmap-item">
        <div class="roadmap-number">5</div>
        <div class="roadmap-content">
          <strong>AI APIコスト最適化</strong>
          <p>トピック分析のモデル選択を段階的に最適化。初回分析のみgpt-5.2を使用し、継続的分析はgpt-5-miniに切り替える戦略を実装。</p>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
    Generated by Claude Code Project Review | 2026-01-29T00:00:00Z
  </div>
</body>
</html>